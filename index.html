<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>HISAB</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      margin: 0;
      background: #f9f9f9;
    }
    .table-wrapper {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      padding: 10px;
      background: white;
      border-radius: 8px;
    }
    table {
      border-collapse: collapse;
      min-width: 300px;
      table-layout: fixed;
      width: 100%;
      max-width: 450px;
    }
    th, td {
      border: 0.8px solid #666;
      padding: 8px;
      text-align: center;
      font-size: 14px;
      vertical-align: middle;
      word-wrap: break-word;
    }
    th {
      font-weight: bold;
      background: #e6e6e6;
      text-transform: uppercase;
    }
    .yellow { background-color: #ffe599; }
    .green { background-color: #d9ead3; }
    .red { background-color: #f4cccc; }
    .heading-row th {
      font-size: 16px;
      background-color: #ffffad;
      color: black;
    }
    .total-row td {
      font-weight: bold;
      background-color: #f0f0f0;
    }
    .actions {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    button {
      padding: 10px 16px;
      font-weight: bold;
      border: 1px solid #000;
      cursor: pointer;
      border-radius: 4px;
    }

    textarea {
      width: auto;
      min-width: 100%;
      min-height: 19px;
      overflow: hidden;
      resize: none;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 14px;
      font-family: inherit;
      text-transform: uppercase;
      outline: none;
    }

    input[type="number"] {
      width: 100%;
      min-height: 18px;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 14px;
      outline: none;
    }

    table td:first-child {
      min-width: 180px;
    }

    @media print {
      body {
        zoom: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="capture" class="table-wrapper">
    <table id="refillTable">
      <thead>
        <tr class="heading-row">
          <th colspan="3">REFILL DIFFERENCE: <span id="refillDiff">0</span></th>
        </tr>
        <tr>
          <th class="yellow">SITE NAME</th>
          <th class="green">SITE REFILL</th>
          <th class="red">SITE WITHDRAWAL</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr class="total-row">
          <td>TOTAL</td>
          <td id="refillTotal">0</td>
          <td id="refillWithdraw">0</td>
        </tr>
      </tfoot>
    </table>

    <table id="withdrawalTable">
      <thead>
        <tr class="heading-row">
          <th colspan="3">WITHDRAWAL DIFFERENCE: <span id="withdrawalDiff">0</span></th>
        </tr>
        <tr>
          <th class="yellow">REFILL ACCOUNT</th>
          <th class="green">REFILL AMOUNT</th>
          <th class="red">WITHDRAWAL AMOUNT</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr class="total-row">
          <td>TOTAL</td>
          <td id="withdrawTotal">0</td>
          <td id="withdrawWithdraw">0</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="actions">
    <button onclick="addRow()">Add Row</button>
    <button onclick="downloadPDF()">Download PDF</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    const refillTable = document.getElementById('refillTable').querySelector('tbody');
    const withdrawalTable = document.getElementById('withdrawalTable').querySelector('tbody');

    function addRow() {
      const refillRow = document.createElement('tr');
      refillRow.innerHTML = `
        <td class="yellow"><textarea oninput="autoGrow(this)"></textarea></td>
        <td class="green"><input type="number" oninput="updateTotals()" /></td>
        <td class="red"><input type="number" oninput="updateTotals()" /></td>
      `;
      refillTable.appendChild(refillRow);

      const withdrawalRow = document.createElement('tr');
      withdrawalRow.innerHTML = `
        <td class="yellow"><textarea oninput="autoGrow(this)"></textarea></td>
        <td class="green"><input type="number" oninput="updateTotals()" /></td>
        <td class="red"><input type="number" oninput="updateTotals()" /></td>
      `;
      withdrawalTable.appendChild(withdrawalRow);

      enforceUppercase();
    }

    function autoGrow(textarea) {
      textarea.style.height = 'auto';
      textarea.style.width = 'auto';
      textarea.style.height = textarea.scrollHeight + "px";
      textarea.style.width = textarea.scrollWidth + "px";
    }

    function updateTotals() {
      let refillTotal = 0, refillWithdraw = 0;
      let withdrawTotal = 0, withdrawWithdraw = 0;

      refillTable.querySelectorAll('tr').forEach(row => {
        const refill = parseFloat(row.cells[1].querySelector('input')?.value) || 0;
        const withdraw = parseFloat(row.cells[2].querySelector('input')?.value) || 0;
        refillTotal += refill;
        refillWithdraw += withdraw;
      });

      withdrawalTable.querySelectorAll('tr').forEach(row => {
        const refill = parseFloat(row.cells[1].querySelector('input')?.value) || 0;
        const withdraw = parseFloat(row.cells[2].querySelector('input')?.value) || 0;
        withdrawTotal += refill;
        withdrawWithdraw += withdraw;
      });

      document.getElementById('refillDiff').textContent = refillTotal - withdrawTotal;
      document.getElementById('withdrawalDiff').textContent = refillWithdraw - withdrawWithdraw;
      document.getElementById('refillTotal').textContent = refillTotal;
      document.getElementById('refillWithdraw').textContent = refillWithdraw;
      document.getElementById('withdrawTotal').textContent = withdrawTotal;
      document.getElementById('withdrawWithdraw').textContent = withdrawWithdraw;
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const captureElement = document.getElementById('capture');

      const canvas = await html2canvas(captureElement, {
        scale: 2,
        useCORS: true,
        scrollY: -window.scrollY,
        windowWidth: document.documentElement.scrollWidth,
        windowHeight: captureElement.scrollHeight,
      });

      const imgData = canvas.toDataURL('image/png');
      const margin = 40;
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;

      const pdf = new jsPDF('l', 'pt', [imgWidth + margin * 2, imgHeight + margin * 2]);
      pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
      pdf.save('Difference_Table.pdf');
    }

    function enforceUppercase() {
      document.querySelectorAll('textarea').forEach(input => {
        input.addEventListener('input', function () {
          const pos = this.selectionStart;
          this.value = this.value.toUpperCase();
          this.setSelectionRange(pos, pos);
        });
      });
    }

    // Init
    addRow();
  </script>
</body>
</html>
